---
title: "Georgia Visuals - SVI & Flood Risk at the County Level"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = F, message = F)
```

```{r}
#saveRDS(percentile_infra_SVI, "percentile_infra_SVI.rds")
```

```{r}
percentile_infra_SVI <- readRDS("percentile_infra_SVI.rds")
```


```{r}
library(tidyverse)
library(sf)
library(tigris)
library(leaflet)
library(knitr)
library(ggplot2)
```

```{r}
percentile_infra_SVI<- percentile_infra_SVI %>% 
  mutate(
  percent_actual = percent_infrastructure_impacted*100, 
  combo_flood_vuln = percent_infrastructure_impacted + overall_vulnerability_perc, 
  combo_flood_socio = percent_infrastructure_impacted + socioeconomic_vulnerability_perc, 
  combo_flood_household = percent_infrastructure_impacted + householdcomp_vulnerability_perc, 
  combo_flood_lang = percent_infrastructure_impacted + minority_vulnerability_perc, 
  combo_flood_housing = percent_infrastructure_impacted + housing_vulnerability_perc
  )
```

### Georgia

```{r  GA}
ga_counties <- counties("GA", cb = T, progress_bar = F)

ga_counties$GEOID <- as.numeric(ga_counties$GEOID)

ga_counties_transformed <- 
  ga_counties %>% 
  st_transform(4269) 

percentile_county_combo_GA <-
  percentile_infra_SVI %>% 
  filter(ST == 13) %>% 
  left_join(
    ga_counties_transformed %>% select(GEOID), 
    by = c("FIPS" = "GEOID")
  ) %>% 
  st_as_sf() 

#use GEOID to join FIPS to transformed coordinates 

```

```{r GA - leaflet}
ga_pal <- colorNumeric(
  palette = "Reds",
  domain = percentile_county_combo_GA$percent_actual
)

leaflet() %>% 
  addTiles() %>% 
  addPolygons(
    data =  percentile_county_combo_GA,
    fillColor = ~ga_pal(percent_actual),
    color = "white",
    opacity = 0.5,
    fillOpacity = 0.5,
    weight = 1,
    label = ~paste0(
      LOCATION,
      " - ",
      round(percent_actual, digits = 1),
      "% Infrastructure Impacted"
    ),
    highlightOptions = highlightOptions(
      weight = 2,
      opacity = 1
    )
  ) %>% 
  addLegend(
    data = percentile_county_combo_GA,
    pal = ga_pal,
    values = ~percent_actual,
    title = "% Infrastructure Impacted"
  )

```


```{r - GA top counties}
percentile_county_combo_GA %>% arrange(percent_infrastructure_impacted) %>% write_csv("GA_counties_flood_perc.csv")

```

# Incorporating Social Vulnerability (Georgia Deep Dive)

## Combined Values - Summing % Infrastructure & National Vulnerability Percentile

### Flood + Overall Vulnerability 
This includes a leaflet map of the combined values as well as a list of the 15 highest ranking counties in Georgia for each vulnerability dimension (4 buckets + overall).

```{r - GA: combining percentile & % infrastructure}

ga_pal <- colorNumeric(
  palette = "Reds",
  domain = percentile_county_combo_GA$combo_flood_vuln
)

leaflet() %>% 
  addTiles() %>% 
  addPolygons(
    data =  percentile_county_combo_GA,
    fillColor = ~ga_pal(combo_flood_vuln),
    color = "white",
    opacity = 0.5,
    fillOpacity = 0.5,
    weight = 1,
    label = ~paste0(
      LOCATION,
      " - ",
      round(combo_flood_vuln, digits = 3)
    ),
    highlightOptions = highlightOptions(
      weight = 2,
      opacity = 1
    )
  ) %>% 
  addLegend(
    data = percentile_county_combo_GA,
    pal = ga_pal,
    values = ~combo_flood_vuln,
    title = "Combined Value: Flood Impact & <br> Overall Vulnerability"
  )

percentile_county_combo_GA %>% arrange(desc(combo_flood_vuln), reverse = TRUE) %>% 
  select(
    COUNTY,
    overall_vulnerability_perc,
    percent_infrastructure_impacted, 
    combo_flood_vuln, 
  ) %>% head(15) %>% kable()
```
### Flood + Socioeconomic Vulnerability 

```{r - GA: socioeconomic percentile & % infrastructure}

ga_pal <- colorNumeric(
  palette = "Reds",
  domain = percentile_county_combo_GA$combo_flood_socio
)

leaflet() %>% 
  addTiles() %>% 
  addPolygons(
    data =  percentile_county_combo_GA,
    fillColor = ~ga_pal(combo_flood_socio),
    color = "white",
    opacity = 0.5,
    fillOpacity = 0.5,
    weight = 1,
    label = ~paste0(
      LOCATION,
      " - ",
      round(combo_flood_socio, digits = 3)
    ),
    highlightOptions = highlightOptions(
      weight = 2,
      opacity = 1
    )
  ) %>% 
  addLegend(
    data = percentile_county_combo_GA,
    pal = ga_pal,
    values = ~combo_flood_socio,
    title = "Combined Value: Flood Impact & <br> Socioeconomic Vulnerability"
  )

percentile_county_combo_GA %>% arrange(desc(combo_flood_socio), reverse = TRUE) %>% 
  select(
    COUNTY,
    socioeconomic_vulnerability_perc,
    percent_infrastructure_impacted, 
    combo_flood_socio, 
  ) %>% head(15) %>% kable()
```

### Flood + Household Composition Vulnerability 

```{r - GA: household composition percentile & % infrastructure}

ga_pal <- colorNumeric(
  palette = "Reds",
  domain = percentile_county_combo_GA$combo_flood_household
)

leaflet() %>% 
  addTiles() %>% 
  addPolygons(
    data =  percentile_county_combo_GA,
    fillColor = ~ga_pal(combo_flood_household),
    color = "white",
    opacity = 0.5,
    fillOpacity = 0.5,
    weight = 1,
    label = ~paste0(
      LOCATION,
      " - ",
      round(combo_flood_household, digits = 3)
    ),
    highlightOptions = highlightOptions(
      weight = 2,
      opacity = 1
    )
  ) %>% 
  addLegend(
    data = percentile_county_combo_GA,
    pal = ga_pal,
    values = ~combo_flood_household,
    title = "Combined Value: Flood Impact & <br> Household Composition Vulnerability"
  )

percentile_county_combo_GA %>% arrange(desc(combo_flood_household), reverse = TRUE) %>% 
  select(
    COUNTY,
    householdcomp_vulnerability_perc,
    percent_infrastructure_impacted, 
    combo_flood_household, 
  ) %>% head(15) %>% kable()
```


### Flood + Language Isolation Vulnerability 

```{r - GA: language isolation percentile & % infrastructure}

ga_pal <- colorNumeric(
  palette = "Reds",
  domain = percentile_county_combo_GA$combo_flood_lang
)

leaflet() %>% 
  addTiles() %>% 
  addPolygons(
    data =  percentile_county_combo_GA,
    fillColor = ~ga_pal(combo_flood_lang),
    color = "white",
    opacity = 0.5,
    fillOpacity = 0.5,
    weight = 1,
    label = ~paste0(
      LOCATION,
      " - ",
      round(combo_flood_lang, digits = 3)
    ),
    highlightOptions = highlightOptions(
      weight = 2,
      opacity = 1
    )
  ) %>% 
  addLegend(
    data = percentile_county_combo_GA,
    pal = ga_pal,
    values = ~combo_flood_lang,
    title = "Combined Value: Flood Impact & <br> Language Isolation Vulnerability"
  )

percentile_county_combo_GA %>% arrange(desc(combo_flood_lang), reverse = TRUE) %>% 
  select(
    COUNTY,
    minority_vulnerability_perc,
    percent_infrastructure_impacted, 
    combo_flood_lang, 
  ) %>% head(15) %>% kable()
```

### Flood + Housing Vulnerability 

```{r - GA: housing percentile & % infrastructure}

ga_pal <- colorNumeric(
  palette = "Reds",
  domain = percentile_county_combo_GA$combo_flood_housing
)

leaflet() %>% 
  addTiles() %>% 
  addPolygons(
    data =  percentile_county_combo_GA,
    fillColor = ~ga_pal(combo_flood_housing),
    color = "white",
    opacity = 0.5,
    fillOpacity = 0.5,
    weight = 1,
    label = ~paste0(
      LOCATION,
      " - ",
      round(combo_flood_housing, digits = 3)
    ),
    highlightOptions = highlightOptions(
      weight = 2,
      opacity = 1
    )
  ) %>% 
  addLegend(
    data = percentile_county_combo_GA,
    pal = ga_pal,
    values = ~combo_flood_housing,
    title = "Combined Value: Flood Impact & <br> Housing Vulnerability"
  )

percentile_county_combo_GA %>% arrange(desc(combo_flood_housing), reverse = TRUE) %>% 
  select(
    COUNTY,
    housing_vulnerability_perc,
    percent_infrastructure_impacted, 
    combo_flood_housing
  ) %>% head(15) %>% kable()
```
## Bivariate Coloring

Using: https://cran.r-project.org/web/packages/biscale/biscale.pdf
Palettes: https://slu-opengis.github.io/biscale/reference/bi_pal.html

```{r - packages}
library(biscale)
library(ggplot2)
library(cowplot)
```

```{r - bivariate data prep}
# Overall Vulnerability Data, 2x2 & 3x3
data_twobytwo <- bi_class(percentile_county_combo_GA, x = percent_infrastructure_impacted, y = overall_vulnerability_perc, style = "quantile", dim = 2) 

data_threebythree <- bi_class(percentile_county_combo_GA, x = percent_infrastructure_impacted, y = overall_vulnerability_perc, style = "quantile", dim = 3)

# Socioeconomic Data
socio_data_threebythree <- bi_class(percentile_county_combo_GA, x = percent_infrastructure_impacted, y = socioeconomic_vulnerability_perc, style = "quantile", dim = 3)


# Household Composition Data
household_data_threebythree <- bi_class(percentile_county_combo_GA, x = percent_infrastructure_impacted, y = householdcomp_vulnerability_perc, style = "quantile", dim = 3)

# Language Isolation  Data
lang_data_threebythree <- bi_class(percentile_county_combo_GA, x = percent_infrastructure_impacted, y = minority_vulnerability_perc, style = "quantile", dim = 3)

# Housing   Data
housing_data_threebythree <- bi_class(percentile_county_combo_GA, x = percent_infrastructure_impacted, y = housing_vulnerability_perc, style = "quantile", dim = 3)

```

```{r - 2x2, Overall Vuln}
ggplot() +
  geom_sf(data = data_twobytwo, mapping = aes(fill = bi_class, geometry = geometry), color = "white", size = 0.1, show.legend = FALSE) +
  bi_scale_fill(pal = "DkBlue", dim = 2) +
  labs(
    title = "Infrastructure Impacted & Overall Vulnerability",
    subtitle = "Dark Blue (DkBlue) Palette"
  ) +
  bi_theme()

legend <- bi_legend(pal = "DkBlue",
                    dim = 2,
                    xlab = "Infrastructure Impacted ",
                    ylab = "Vulnerability",
                    size = 10)

legend
```

```{r - 3x3 - Overall Vuln}
ggplot() +
  geom_sf(data = data_threebythree, mapping = aes(fill = bi_class, geometry = geometry), color = "white", size = 0.1, show.legend = FALSE) +
  bi_scale_fill(pal = "DkBlue", dim = 3) +
  labs(
    title = "Infrastructure Impacted & Overall Vulnerability",
    subtitle = "Dark Blue (DkBlue) Palette"
  ) +
  bi_theme()

legend <- bi_legend(pal = "DkBlue",
                    dim = 3,
                    xlab = "Infrastructure Impacted",
                    ylab = "Overall Vulnerability",
                    size = 10)

legend

```
```{r - 3x3 - Socio Vuln}
ggplot() +
  geom_sf(data = socio_data_threebythree, mapping = aes(fill = bi_class, geometry = geometry), color = "white", size = 0.1, show.legend = FALSE) +
  bi_scale_fill(pal = "DkBlue", dim = 3) +
  labs(
    title = "Infrastructure Impacted & Socioeconomic Vulnerability",
    subtitle = "Dark Blue (DkBlue) Palette"
  ) +
  bi_theme()

legend <- bi_legend(pal = "DkBlue",
                    dim = 3,
                    xlab = "Infrastructure Impacted",
                    ylab = "Socioeconomic Vulnerability",
                    size = 10)

legend

```

```{r - 3x3 - Household Vuln}
ggplot() +
  geom_sf(data = household_data_threebythree, mapping = aes(fill = bi_class, geometry = geometry), color = "white", size = 0.1, show.legend = FALSE) +
  bi_scale_fill(pal = "DkBlue", dim = 3) +
  labs(
    title = "Infrastructure Impacted & Household Vulnerability",
    subtitle = "Dark Blue (DkBlue) Palette"
  ) +
  bi_theme()

legend <- bi_legend(pal = "DkBlue",
                    dim = 3,
                    xlab = "Infrastructure Impacted",
                    ylab = "Household Vulnerability",
                    size = 10)

legend

```

```{r - 3x3 - Lang Isolation Vuln}
ggplot() +
  geom_sf(data = lang_data_threebythree, mapping = aes(fill = bi_class, geometry = geometry), color = "white", size = 0.1, show.legend = FALSE) +
  bi_scale_fill(pal = "DkBlue", dim = 3) +
  labs(
    title = "Infrastructure Impacted & Language Isolation Vulnerability",
    subtitle = "Dark Blue (DkBlue) Palette"
  ) +
  bi_theme()

legend <- bi_legend(pal = "DkBlue",
                    dim = 3,
                    xlab = "Infrastructure Impacted",
                    ylab = "Language Isolation Vulnerability",
                    size = 10)

legend

```


```{r - 3x3 - Housing Vuln}
ggplot() +
  geom_sf(data = housing_data_threebythree, mapping = aes(fill = bi_class, geometry = geometry), color = "white", size = 0.1, show.legend = FALSE) +
  bi_scale_fill(pal = "DkBlue", dim = 3) +
  labs(
    title = "Infrastructure Impacted & Housing Vulnerability",
    subtitle = "Dark Blue (DkBlue) Palette"
  ) +
  bi_theme()

legend <- bi_legend(pal = "DkBlue",
                    dim = 3,
                    xlab = "Infrastructure Impacted",
                    ylab = "Housing Vulnerability",
                    size = 10)

legend

```

## Trivariate Coloring (in profre)

Using: https://cran.r-project.org/web/packages/tricolore/vignettes/choropleth_maps_with_tricolore.html

```{r - libraries}
library(ggtern)
library(tricolore)
```

```{r - prep color & trivariate data}
tric <- Tricolore(percentile_county_combo_GA, p1 = 'percent_infrastructure_impacted', p2 = 'minority_vulnerability_perc', p3 = 'socioeconomic_vulnerability_perc', legend = TRUE)

percentile_county_combo_GA$rgb <- tric$rgb
```

```{r}
tri_plot <-
  ggplot(percentile_county_combo_GA) +
  geom_sf(aes(fill = rgb, geometry = geometry), size = 0.1) +
  scale_fill_identity() 

tri_plot
```

```{r}
tri_plot <-
  tri_plot +
  annotation_custom(
    ggplotGrob(tric$key +
                 theme(plot.background = element_rect(fill = NA, color = NA)) +
                 labs(L = '0-2', T = '3-4', R = '5-8')),
    xmin = 30.3575, xmax = 34.9996, ymin = -85.6082, ymax =  -80.696
  )

tri_plot
```




